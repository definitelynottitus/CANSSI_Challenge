---
title: "CANSSI Challenge"
author: "Titus"
date: '2019-09-14'
output: html_document
---

```{r}
library(mice)
library(dplyr)
library(pscl)
library(caret)
test = read.csv("test.csv")
vancouver = read.csv("vancouver.csv")
train = read.csv("train.csv")
traffic = read.csv("traffic.csv")
victoria = read.csv("victoria.csv")
train.merge2 = read.csv("train_mod2.csv")
train.merge2 = dplyr::select(train.merge2,-X)
```

```{r}
#Format the time date to join in to the training set, timezone GMT is used to avoid converstion error in PDT
#The time in the training set is round to hourly to better match the time in the weather data set
vancouver$formatedTimeDate = as.POSIXct(strptime(vancouver$Date.Time, "%Y-%m-%d %H:%M:%S"),tz = "GMT")
victoria$formatedTimeDate = as.POSIXct(strptime(victoria$Date.Time, "%Y-%m-%d %H:%M:%S"),tz = "GMT")
correctTime = format(strptime(train$Scheduled.Departure, "%I:%M %p"), format="%H:00:00")
correctDate = paste(train$Year,"-",match(train$Month,month.name),"-",train$Day.of.Month,sep = "")
correctTimeDate = paste(correctDate,correctTime)
train$formatedTimeDate = as.POSIXct(strptime(correctTimeDate,"%Y-%m-%d %H:%M:%S"),tz = "GMT")
VanWeather = vancouver[vancouver$formatedTimeDate >= "2016-08-28 05:15:00" &
                            vancouver$formatedTimeDate <= "2017-11-27 22:45:00",]
VictWeather = victoria[victoria$formatedTimeDate >= "2016-08-28 05:15:00" &
                            victoria$formatedTimeDate <= "2017-11-27 22:45:00",]
```

```{r}
#Joining the data using left join and droping redudants columns
train.merged = left_join(train,VanWeather,by = "formatedTimeDate")
train.merged = left_join(train.merged,VictWeather,by = "formatedTimeDate")
train.merged = select(train.merged,-c(Date.Time.x,Date.Time.y,Year.y,Month.y,Day.y,Time.x,Weather,
                         Full.Date,Year.x,Hour.x,Humidex.in.Celsius,Time.y,Year,Month,Day,Hour.y))


tempData = mice(select(train.merged,
                       Temperature.in.Celsius.x,
                       Dew.Point.Temperature.in.Celsius.x,
                       Relative.Humidity.in.Percent.x,
                       Temperature.in.Celsius.y,
                       Dew.Point.Temperature.in.Celsius.y,
                       Relative.Humidity.in.Percent.y,
                       Wind.Direction.in.Degrees,
                       Wind.Speed.km.per.h,
                       Visibility.in.km,
                       Station.Pressure.in.kPa),
                m=5,maxit = 5,method = "pmm",seed = 500)
completeData = complete(tempData,1)
#Drop old data that was use to impute

train.merged = select(train.merged,
                      -c(Temperature.in.Celsius.x,
                       Dew.Point.Temperature.in.Celsius.x,
                       Relative.Humidity.in.Percent.x,
                       Temperature.in.Celsius.y,
                       Dew.Point.Temperature.in.Celsius.y,
                       Relative.Humidity.in.Percent.y,
                       Wind.Direction.in.Degrees,
                       Wind.Speed.km.per.h,
                       Visibility.in.km,
                       Station.Pressure.in.kPa,
                       Trip.Duration))
names(completeData) = c("VanTemp_C","Van.DewPointTemp_C",
                        "VanRelativeHumid_Percent","VictTemp_C",
                        "VictDewPointTemp_C","VictRelativeHumid_Percent",
                        "VictWindDirection_Deg","VictWindSpeed_kmh",
                        "VictVisibility_km","VictStaionPressure_kPa")
names(train.merged)[5:6] = c("Day","Month")
train.merged = cbind(train.merged,completeData)
# only run to save the data
# write.csv(train.merged,"train_mod1.csv")
```


```{r}
correctTime = format(strptime(test$Scheduled.Departure, "%I:%M %p"), format="%H:00:00")
correctDate = paste(test$Year,"-",match(test$Month,month.name),"-",test$Day.of.Month,sep = "")
correctTimeDate = paste(correctDate,correctTime)
test$formatedTimeDate = as.POSIXct(strptime(correctTimeDate,"%Y-%m-%d %H:%M:%S"),tz = "GMT")
VanWeather2 = vancouver[vancouver$formatedTimeDate >= "2017-11-27 05:00:00" &
                            vancouver$formatedTimeDate <= "2018-03-30 22:00:00",]
VictWeather2 = victoria[victoria$formatedTimeDate >= "2017-11-27 05:00:00" &
                            victoria$formatedTimeDate <= "2018-03-30 22:00:00",]


test.merged = left_join(test,VanWeather2,by = "formatedTimeDate")
test.merged = left_join(test.merged,VictWeather2,by = "formatedTimeDate")
test.merged = select(test.merged,
                      -c(Date.Time.x,Date.Time.y,Year.y,Month.y,Day.y,Time.x,Weather,
                         Full.Date,Year.x,Hour.x,Humidex.in.Celsius,Time.y,Year,Month,Day,Hour.y))

tempData2 = mice(select(test.merged,
                       Temperature.in.Celsius.x,
                       Dew.Point.Temperature.in.Celsius.x,
                       Relative.Humidity.in.Percent.x,
                       Temperature.in.Celsius.y,
                       Dew.Point.Temperature.in.Celsius.y,
                       Relative.Humidity.in.Percent.y,
                       Wind.Direction.in.Degrees,
                       Wind.Speed.km.per.h,
                       Visibility.in.km,
                       Station.Pressure.in.kPa),
                m=5,maxit = 5,method = "pmm",seed = 500)
completeData2 = complete(tempData2,1)

test.merged = select(test.merged,
                      -c(Temperature.in.Celsius.x,
                       Dew.Point.Temperature.in.Celsius.x,
                       Relative.Humidity.in.Percent.x,
                       Temperature.in.Celsius.y,
                       Dew.Point.Temperature.in.Celsius.y,
                       Relative.Humidity.in.Percent.y,
                       Wind.Direction.in.Degrees,
                       Wind.Speed.km.per.h,
                       Visibility.in.km,
                       Station.Pressure.in.kPa))
names(completeData2) = c("VanTemp_C","Van.DewPointTemp_C",
                        "VanRelativeHumid_Percent","VictTemp_C",
                        "VictDewPointTemp_C","VictRelativeHumid_Percent",
                        "VictWindDirection_Deg","VictWindSpeed_kmh",
                        "VictVisibility_km","VictStaionPressure_kPa")
names(test.merged)[5:6] = c("Day","Month")
test.merged = cbind(test.merged,completeData2)

col1 = levels(test.merged$Scheduled.Departure)
col2 = levels(train.merged$Scheduled.Departure)
timelevel <- unique(c(col1, col2))
train.merged$Scheduled.Departure = factor(test.merged$Scheduled.Departure,levels = timelevel)
test.merged$Scheduled.Departure = factor(test.merged$Scheduled.Departure,levels = timelevel)
```


```{r}
trainset = createDataPartition(train.merge2$Delay.Indicator, p = .6, list = FALSE)
training = train.merge2[trainset,]
testing = train.merge2[-trainset,]

ctrl = trainControl(method = "repeatedcv", number = 10, savePredictions = TRUE)
colnames(train.merge2)
mod_fit = train(Delay.Indicator ~
                  Vessel.Name + 
                  Departure +
                  Arrive + 
                  ave.traffic +
                  Van_Temp_Cel +
                  Van_Relative_Humidity_Per +
                  Vic_Temp_Cel +
                  Vic_Wind_Speed +
                  Vic_Relative_Humidity_Per +
                  Vic_Visibility +
                  Vic_Station.Pressure +
                  Day + Month + Hour +
                  Day.of.Month +
                  Day:ave.traffic +
                  Hour:ave.traffic +
                  Departure:ave.traffic,
                data = train.merge2,
                method="glm",
                family="binomial",
                trControl = ctrl,
                tuneLength = 5)

pred = data.frame(predict(mod_fit, newdata = testing))

pred$Delay.Indicator = ifelse(pred$predict.mod_fit..newdata...testing. >= 0.5,1,0)
pred$Delay.Indicator = factor(pred$Delay.Indicator)

testing$Delay.Indicator = factor(testing$Delay.Indicator)
pred = select(pred,-predict.mod_fit..newdata...testing.)

levels(pred$Delay.Indicator)
levels(testing$Delay.Indicator)
confusionMatrix(data = pred$Delay.Indicator, testing$Delay.Indicator)


```

```{r}
mprediction = predict(mymodel,test.merged,type = "response")
mpredict = data.frame(mprediction)
table(train.merged$Delay.Indicator)
result = ifelse(mpredict$mprediction>=0.5,1,0)
result
#final_result = cbind(test.merged$ID,ifelse(mpredict$mprediction>=0.5,1,0))
#final_result = data.frame(final_result)
```

